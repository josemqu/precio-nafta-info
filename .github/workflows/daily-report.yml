name: Daily API Report

on:
  schedule:
    # Ejecuta cada 3 horas 
    - cron: '0 */3 * * *'
  
  # Permite ejecución manual desde GitHub
  workflow_dispatch:
    inputs:
      startDate:
        description: 'Fecha de inicio (YYYY-MM-DD)'
        required: false
        type: string
      endDate:
        description: 'Fecha de fin (YYYY-MM-DD)'
        required: false
        type: string

jobs:
  send-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send API Report
        run: |
          # Construir URL con parámetros opcionales
          set -euo pipefail
          BASE_URL="${{ secrets.APP_URL }}"
          # Normalizar para evitar doble '/'
          BASE_URL="${BASE_URL%/}"
          URL="${BASE_URL}/trigger-report"
          
          echo "Checking health at: ${BASE_URL}/health"
          curl -sS -o /dev/null -w "Health HTTP Status: %{http_code}\n" "${BASE_URL}/health" || true
          
          echo "Triggering report at: $URL"
          
          # Enviar POST (el endpoint acepta POST con JSON body)
          if [ -n "${{ github.event.inputs.startDate }}" ] && [ -n "${{ github.event.inputs.endDate }}" ]; then
            payload=$(jq -n --arg s "${{ github.event.inputs.startDate }}" --arg e "${{ github.event.inputs.endDate }}" '{startDate:$s, endDate:$e}')
            response=$(curl -sS -L -H "Content-Type: application/json" -X POST -d "$payload" -w "HTTPSTATUS:%{http_code}" "$URL")
          else
            response=$(curl -sS -L -H "Content-Type: application/json" -X POST -w "HTTPSTATUS:%{http_code}" "$URL")
          fi
          
          # Extraer código de estado
          http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          body=$(echo $response | sed -e 's/HTTPSTATUS\:.*//g')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          # Verificar si fue exitoso
          if [ $http_code -eq 200 ]; then
            echo "✅ Report sent successfully!"
          else
            echo "❌ Failed to send report"
            exit 1
          fi
